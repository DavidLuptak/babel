\AddBabelHook{luatex}{patterns}{%
  \ifx\directlua\relax\else
    \ifcsname lu@texhyphen@loaded@\the\language\endcsname \else
      \global\@namedef{lu@texhyphen@loaded@\the\language}{}%
      \directlua{
	if not luatexhyphen then
	    dofile(assert(kpse.find_file("luatex-hyphen.lua")))
	end
	luatexhyphen.loadlanguage("\luaescapestring{#1}",
	  \the\language)}%
    \fi
  \fi}

\AddBabelHook{luatex}{adddialect}{%
  \ifx\directlua\relax\else
    \directlua{
      if not luatexhyphen then
	  dofile(assert(kpse.find_file("luatex-hyphen.lua")))
      end
      luatexhyphen.adddialect("\string#1", "\string#2")
    }%
  \fi}

\AddBabelHook{luatex}{beforeprocess}{%
  \directlua{
    if not luatexhyphen then
      dofile(assert(kpse.find_file("luatex-hyphen.lua")))
    end
    processnow = (tex.language == 0) or
      (luatexhyphen.lookupname("\luaescapestring{#1}") == nil)}%
  \ifnum0=\directlua{tex.sprint(processnow and "0" or "1")}\relax
    \global\toks8\expandafter{\the\toks8#1, }%
    \global\@namedef{lu@texhyphen@loaded@\the\language}{}%
  \fi}


\AddBabelHook{luatex}{inputprocess}{%
  \ifnum0=\directlua{tex.sprint(processnow and "0" or "1")}\relax
    \input #1\relax
  \fi}


\AddBabelHook{luatex}{exceptfile}{%
  \ifnum0=\directlua{tex.sprint(processnow and "0" or "1")}\relax
    \input #1\relax
  \fi
  \directlua{processnow = nil}}